apiVersion: batch/v1
kind: CronJob
metadata:
  name: delete-dymamic-plugins-lock
spec:
  successfulJobsHistoryLimit: 3
  concurrencyPolicy: Replace
  schedule: "* * * * *"
  jobTemplate:
    spec:
      backoffLimit: 0
      template:
        spec:
          containers:
          - name: delete-dymamic-plugins-lock
            image: registry.redhat.io/openshift4/ose-tools-rhel9@sha256:8037187950e7374a9c9bec4996033c9b24ce374920ef29047d4f63b4c20f3e6b
            command:
              - /bin/bash
            args:
              - '-ec'
              - >-
                POD=$(oc get pod -n {{ .Release.Namespace }} -l app.kubernetes.io/name=developer-hub -o jsonpath='{.items[0].metadata.name}')

                echo "Found pod $POD"

                if [[ ! -z "${POD}" ]]; then

                  POD_PHASE=$(oc get pod $POD -n {{ .Release.Namespace }} -o json | jq -r '.status.phase')

                  echo "Pod $POD in phase $POD_PHASE"

                  if [[ "${POD_PHASE}" == "Pending" ]]; then

                    CONTAINER_LOG_GREP=$(oc logs $POD  -n {{ .Release.Namespace }} -c install-dynamic-plugins --ignore-errors=true | grep '======= Waiting for lock release...' || true)

                    echo "Container log grep: $CONTAINER_LOG_GREP"

                    if [[ ! -z "${CONTAINER_LOG_GREP}" ]]; then

                      echo "Deleting lock file from install-dynamic-plugins container"

                      oc exec -n {{ .Release.Namespace }} $POD -c install-dynamic-plugins -- rm -f /dynamic-plugins-root/install-dynamic-plugins.lock
                    fi

                  fi

                fi
          restartPolicy: Never
          serviceAccountName: job-runner
